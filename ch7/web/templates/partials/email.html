<!-- Extend our site layout -->
{% extends "layout.html" %}

<!-- Include our common macro set -->
{% import "macros.jnj" as common %}

<!-- Display a label for a field -->
{% macro display_label(name) -%}
  {% if name -%}
    <div class="span" style="width: 80px;">{{ name }}:</div>
  {% endif -%}
{% endmacro -%}

<!-- Display other fields as wider spans -->
{% macro display_field(key, name) -%}
  {% if email[key] -%}
    <div class="row">
      {{ display_label(name) }}
      {{ email[key] }}
    </div>
  {% endif -%}
{% endmacro -%}

<!-- Display a list of emails across a span, as in to/from/cc/bcc/reply_to -->
{% macro display_email_addresses(name, emails) -%}
  <div class="row">
  {% if emails -%}
    {{ display_label(name) }}
    {% if emails is mapping -%}
      {{ display_email_address(emails)|safe }}
    {% elif emails is iterable %}
      {% for e in emails -%}
        {{ display_email_address(e) }}
      {% endfor -%}
    {% endif -%}
  {% endif -%}
  </div>
{% endmacro -%}

{% macro display_email_address(email_record) -%}
  {% if email_record['real_name']-%}
    {{ email_record['real_name']|safe + '" <' + email_record['address']|safe + '>' }}
  {% else -%}
    {{ '<' + email_record['address'] + '>'}}
  {% endif -%}
{% endmacro -%}

<!-- Link to another message ID -->
{% macro display_in_reply_to(key, name) %}
  {% if email[key] != 'None' -%}
    <div class="row">
      {{ display_label(name) }}
      {{ common.display_link(email[key], '/email', email[key])|safe }}
    </div>
  {% endif -%}
{% endmacro -%}

<!-- Convert the carriage returns in a message body to HTML endlines -->
{% macro convert_body(body) -%}
  {{ body.replace('\r\n', '<br />')|safe }}
{% endmacro -%}

<!-- Display the email body -->
{% macro display_body(record) -%}
  {% if(record['body']) -%}
  <div class="row">
    <div class="span" style="display: inline-block; margin-top: 17px; background-color: #F7F7F7; padding: 10px;">
      {{ convert_body(record['body']) }}
    </div>
  </div>
  {% endif -%}
{% endmacro -%}

<!-- Block in which content appears in superclass - layout.html -->
{% block content -%}
  <div class="page-header">
    <h1>Analytic Inbox</h1>
  </div>
  <p class="lead">Email ID: {{email['message_id']}}</p>
  <div>
  {{ display_email_addresses('From', email['from']) }}
  {{ display_email_addresses('To', email['tos']) }}
  {{ display_email_addresses('Cc', email['ccs']) }}
  {{ display_email_addresses('Bcc', email['bccs']) }}
  {{ display_email_addresses('Reply-To', email['reply_tos']) }}
  
  {{ display_in_reply_to('in_reply_to', 'In-Reply-To') }}
  {{ display_field('date', 'Date') }}
  {{ display_field('subject', 'Subject')}}
  
  {{ display_body(email) }}
  </div>
{% endblock -%}