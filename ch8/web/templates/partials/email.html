<!-- Extend our site layout -->
{% extends "layout.html" %}

<!-- Include our common macro set -->
{% import "macros.jnj" as common %}

<!-- Link to another message ID -->
{% macro display_in_reply_to(key, name) %}
  {% if email[key] != 'None' -%}
    <div class="row">
      {{ common.display_label(name)|safe }}
      {{ common.display_link(email[key], '/email', email[key])|safe }}
    </div>
  {% endif -%}
{% endmacro -%}

<!-- Convert the carriage returns in a message body to HTML endlines -->
{% macro convert_body(body) -%}
  {{ body.replace('\r\n', '<br />')|safe }}
{% endmacro -%}

<!-- Display the email body -->
{% macro display_email_body(record) -%}
  {% if(record['body']) -%}
  <div class="row">
    <div class="span" style="display: inline-block; margin-top: 17px; background-color: #F7F7F7; padding: 10px;">
      {{ convert_body(record['body']) }}
    </div>
  </div>
  {% endif -%}
{% endmacro -%}

<!-- Block in which content appears in superclass - layout.html -->
{% block content -%}
  <div class="page-header">
    <h1>Analytic Inbox</h1>
  </div>
  <p class="lead">Email ID: {{email['message_id']}}</p>
  <div class="row">
    <div class="span6">
      {{ common.display_email_addresses('From', email['from'])|safe }}
      {{ common.display_email_addresses('To', email['tos'])|safe }}
      {{ common.display_email_addresses('Cc', email['ccs'])|safe }}
      {{ common.display_email_addresses('Bcc', email['bccs'])|safe }}
      {{ common.display_email_addresses('Reply-To', email['reply_tos'])|safe }}
  
      {{ display_in_reply_to('in_reply_to', 'In-Reply-To') }}
      {{ common.display_field(email['date'], 'Date')|safe }}
      {{ common.display_field(email['subject'], 'Subject')|safe }}
  
      {{ display_email_body(email) }}
    </div>
    <div class="span4">
    {% if addresses -%}
      <div>
        <h3 style="margin-bottom: 5px;">Email Addresses</h2>
        <ul class="nav nav-pills">
          {% for item in addresses -%}
          <li class="active">
            <a style="margin: 3px;" href="/email_address/{{ item['address'] }}">{{ item['address'] }}</a>
          </li>
          {% endfor -%}
        </ul>
      </div>
    {% endif -%}
    {% if sent_distributions -%}
      <div>
        <table class="table table-striped table-condensed">
          <thead>
            <th>From</th>
            <th>Subject</th>
            <th>Date</th>
          </thead>
          <tbody>
            {% for item in emails %}
            <tr style="white-space:nowrap;">
              <td>{{ common.display_email_address(email['from'])|safe }}</td>
              <td>{{ common.display_link(email['message_id'], '/email', email['subject'])|safe }}</td>
              <td style="white-space:nowrap;">{{ email['date'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div id="chart">
        
      </div>
      <script>
      nv.addGraph(function() {
        var chart = nv.models.discreteBarChart()
            .x(function(d) { return d.sent_hour })
            .y(function(d) { return d.total })
            .staggerLabels(true)
            .tooltips(false)
            .showValues(true)

        d3.select('#chart svg')
            .datum(data)
          .transition().duration(500)
            .call(chart);

        nv.utils.windowResize(chart.update);

        return chart;
      });
      </script>
    {% endif -%}
    </div>
  </div>
{% endblock -%}